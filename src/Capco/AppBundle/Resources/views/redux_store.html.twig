{% set stepId = currentStep.id|default(null) %}

{% if currentStep is defined and currentStep.type is defined %}
    {% if currentStep.type == 'collect' %}
        {% set stepId = stepId|toGlobalId('CollectStep') %}
    {% elseif currentStep.type == 'selection' %}
        {% set stepId = stepId|toGlobalId('SelectionStep') %}
    {% elseif currentStep.type == 'synthesis' %}
        {% set stepId = stepId|toGlobalId('SynthesisStep') %}
    {% endif %}
{% endif %}
{% set currentProjectById = null %}
{% if project is defined %}
    {% set currentProjectById = project.id|toGlobalId('Project') %}
{% endif %}

{% set state = {
    'default': {
        'themes': themes_list(),
        'images': {
            'avatar': media_public_url(null|capco_default_avatar, 'default_avatar'),
        },
        'features': features_list(),
        'userTypes': user_type_list()|default([]),
        'parameters': site_parameters_list(),
        'ssoList': sso_list(),
    },
    'user': {
        'mapTokens': capco_map_tokens(),
        'registration_form': registration_form_serialize(),
        'user': app.user
        ? {
            'id': app.user.id|toGlobalId('User'),
            'username': app.user.username,
            'isEmailConfirmed': app.user.isEmailConfirmed,
            'isPhoneConfirmed': app.user.isPhoneConfirmed,
            'phone': app.user.phone,
            'isAdmin': app.user.isAdmin,
            'isEvaluer': app.user.isEvaluer,
            'email': app.user.email,
            'newEmailToConfirm': app.user.newEmailToConfirm,
            'media': app.user.media
            ? {
                'url': media_public_url(app.user.media, 'default_avatar')
            }
            : null,
            'displayName': app.user.username,
            'uniqueId': app.user.slug,
            'roles': app.user.roles,
        }
        : null,
    },
    'project': {
        'showConsultationPlanById': {},
        'selectedActiveItems': [],
        'currentProjectStepById': stepId,
        'currentProjectById': currentProjectById,
        'projectsById': list_projectsById(),
        'limit': projectReducerData.limit|default(null),
        'orderBy': projectReducerData.orderBy|default(null),
        'term': projectReducerData.term|default(null),
        'type': projectReducerData.type|default(null),
        'theme': projectReducerData.theme|default(null)
    },
} %}
{% set state = state|merge(data is defined ? data : {}) %}
{{ redux_store('appStore', state) }}
